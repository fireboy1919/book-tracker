[tools]
node = "22"
go = "1.21.0"

[env]
# Backend environment variables
JWT_SECRET = "dev-secret-key-change-in-production"
DATABASE_URL = "file:./backend/booktracker.db"
PORT = "8080"

# Frontend environment variables  
VITE_API_URL = "http://localhost:8080/api"

[tasks.install]
description = "Install all dependencies"
run = [
    "echo 'ğŸ“¦ Installing frontend dependencies...'",
    "cd frontend && npm install",
    "echo 'ğŸ“¦ Installing backend dependencies...'", 
    "cd backend-go && go mod download"
]

[tasks.dev]
description = "Start both frontend and backend in development mode"
depends = ["install"]
run = [
    "echo 'ğŸš€ Starting development servers...'",
    "mise run backend:dev & mise run frontend:dev & wait"
]


[tasks."backend:dev"]
description = "Start backend in development mode"
depends = ["backend:build"]
env = { DATABASE_URL = "file:./booktracker.db", JWT_SECRET = "dev-secret-key-change-in-production", PORT = "8080" }
run = [
    "echo 'ğŸš€ Starting Go backend...'",
    "cd backend-go && ./book-tracker-go"
]


[tasks."backend:build"]
description = "Build backend application"
run = [
    "echo 'ğŸ”¨ Building Go backend...'",
    "cd backend-go && go build -o book-tracker-go ."
]



[tasks."backend:test"]
description = "Run backend tests"
run = [
    "echo 'ğŸ§ª Running Go backend tests...'",
    "cd backend-go && go test ./... -v"
]


[tasks."frontend:dev"]
description = "Start frontend in development mode"
run = [
    "echo 'âš›ï¸  Starting React frontend...'",
    "cd frontend && npm run dev"
]

[tasks."frontend:build"]
description = "Build frontend for production"
run = [
    "echo 'ğŸ“¦ Building frontend...'",
    "cd frontend && npm run build"
]

[tasks."frontend:preview"]
description = "Preview production build"
depends = ["frontend:build"]
run = [
    "echo 'ğŸ‘€ Previewing production build...'",
    "cd frontend && npm run preview"
]

[tasks.test]
description = "Run all tests"
run = [
    "echo 'ğŸ§ª Running all tests...'",
    "mise run backend:test",
    "mise run frontend:test",
    "echo 'âœ… All tests completed'"
]

[tasks."frontend:test"]
description = "Run frontend unit tests"
run = [
    "echo 'âš›ï¸  Running React tests...'",
    "cd frontend && npm test -- --run"
]

[tasks."frontend:test:watch"]
description = "Run frontend tests in watch mode"
run = [
    "echo 'ğŸ‘€ Running React tests in watch mode...'",
    "cd frontend && npm test"
]

[tasks."test:e2e"]
description = "Run end-to-end tests"
depends = ["install"]
run = [
    "echo 'ğŸŒ Running E2E tests...'",
    "cd frontend && npx playwright install",
    "cd frontend && npm run test:e2e"
]

[tasks."test:e2e:ui"]
description = "Run E2E tests with UI"
depends = ["install"]
run = [
    "echo 'ğŸ­ Running E2E tests with UI...'",
    "cd frontend && npx playwright install",
    "cd frontend && npm run test:e2e:ui"
]

[tasks."test:all"]
description = "Run all tests including E2E"
run = [
    "echo 'ğŸš€ Running complete test suite...'",
    "mise run backend:test",
    "mise run frontend:test",
    "mise run test:e2e",
    "echo 'ğŸ‰ All tests completed successfully!'"
]

[tasks.build]
description = "Build both frontend and backend"
run = [
    "echo 'ğŸ”¨ Building entire application...'",
    "mise run backend:build",
    "mise run frontend:build",
    "echo 'âœ… Build completed'"
]

[tasks.clean]
description = "Clean all build artifacts"
run = [
    "echo 'ğŸ§¹ Cleaning build artifacts...'",
    "rm -rf frontend/node_modules frontend/dist",
    "rm -f backend-go/book-tracker-go",
    "rm -f booktracker.db*",
    "echo 'âœ… Cleanup completed'"
]

[tasks.setup]
description = "Initial project setup"
run = [
    "echo 'ğŸ¯ Setting up Book Tracker development environment...'",
    "echo 'ğŸ“‹ Checking dependencies...'",
    "go version",
    "node --version", 
    "echo 'ğŸ“¦ Installing dependencies...'",
    "mise run install",
    "echo 'âœ… Setup completed! Run: mise run dev'",
    "echo 'ğŸŒ Frontend: http://localhost:5173'",
    "echo 'ğŸ”— Backend:  http://localhost:8080'",
    "echo 'ğŸ“Š Health:   http://localhost:8080/health'"
]

[tasks.docker]
description = "Build and run Docker container"
run = [
    "echo 'ğŸ³ Building Docker image...'",
    "cd backend-go && docker build -t book-tracker .",
    "echo 'ğŸš€ Running Docker container...'",
    "docker run -p 8080:8080 -e JWT_SECRET=docker-secret book-tracker"
]

[tasks.check]
description = "Health check all services"
run = [
    "echo 'ğŸ¥ Checking service health...'",
    "echo 'Backend health:'",
    "curl -f http://localhost:8080/health || echo 'Backend not responding'",
    "echo '\\nFrontend:'", 
    "curl -f http://localhost:5173 || echo 'Frontend not responding'"
]

[tasks.reset-db]
description = "Reset database (delete and recreate)"
run = [
    "echo 'ğŸ—‘ï¸  Resetting database...'",
    "rm -f booktracker.db*",
    "echo 'âœ… Database reset. Will be recreated on next start.'"
]

[tasks.prod]
description = "Build and run production version"
run = [
    "echo 'ğŸ­ Building for production...'",
    "mise run build",
    "echo 'ğŸš€ Starting production servers...'",
    "mise run backend:dev & mise run frontend:preview & wait"
]
